# 产品需求文档 (PRD) - 活码生成平台

| 项目名称 | 活码生成平台 (Dynamic QR Code Generator) |
| --- | --- |
| **版本号** | V1.0.0 |
| **状态** | 待开发 |
| **技术栈** | Next.js (Full Stack), SQLite, Prisma (推荐) |

---

## 1. 项目背景与目标

开发一个基于 Next.js 的全栈活码生成系统。用户可以通过该平台创建“活码”（动态二维码）。与普通二维码不同，活码的内容（目标链接或图片）可以在不改变二维码图案的情况下随时修改。系统内置积分经济体系，通过积分限制创建数量，并通过邀请机制实现用户裂变。

## 2. 用户角色

* **游客**：浏览落地页，注册/登录。
* **注册用户**：创建活码、管理活码、查看积分、修改目标地址、分享邀请链接。

---

## 3. 核心业务流程

### 3.1 积分体系逻辑

1. **初始赠送**：用户首次注册登录，账户自动获得 **20 积分**。
2. **创建消耗**：每创建一个活码，扣除 **10 积分**。
* *判断逻辑*：点击创建时，若 `积分 < 10`，提示“积分不足”，禁止创建。


3. **邀请奖励**：
* 每个用户拥有唯一的邀请链接（如 `domain.com/register?ref=USER_ID`）。
* 新用户通过该链接完成注册后，邀请人账户增加 **10 积分**。
* 被邀请人获得正常的初始 20 积分。



### 3.2 IP 限制逻辑

* **规则**：同一个 IP 地址只能注册一个账号。
* **实现**：注册接口需获取请求 IP，查询数据库中是否已存在该 IP 的用户。若存在，拒绝注册并提示错误。

---

## 4. 功能需求详情

### 4.1 认证模块 (Auth)

* **注册**：
* 字段：用户名/邮箱、密码、确认密码。
* 逻辑：校验 IP 唯一性；检查是否包含邀请码（ref code）；创建用户并初始化积分。


* **登录**：
* 字段：用户名/邮箱、密码。
* 逻辑：JWT 或 Session 认证。


* **注销**：退出当前登录状态。

### 4.2 活码管理模块 (Core)

* **创建活码**：
* **输入类型选择**：
1. **链接模式**：用户输入目标 URL（如微信公众号文章、官网）。
2. **图片模式**：用户上传一张二维码图片（如个人微信、群二维码），系统上传至存储并将返回的 URL 作为目标。


* **生成逻辑**：系统生成一个短链接（如 `domain.com/q/xyz123`），并为此短链接生成二维码图片展示给用户。
* **扣费**：事务操作，创建成功同时扣除 10 积分。


* **活码列表**：
* 展示用户创建的所有活码。
* 显示信息：活码缩略图、目标类型、创建时间、当前状态。


* **编辑活码**：
* 用户可以修改活码指向的目标（更换 URL 或 更换上传的图片）。
* **关键点**：修改后，原有的二维码图案不变，只是扫描后的跳转终点改变。


* **下载二维码**：用户可下载生成的活码图片。

### 4.3 短链接跳转系统 (Redirect System)

* **访问路径**：`domain.com/q/[short_code]`
* **处理逻辑**：
1. 接收请求，解析 `short_code`。
2. 查询数据库找到对应的目标（Target URL 或 Image URL）。
3. 执行 **302 重定向** (302 Redirect) 到目标地址。


* *注*：如果是图片模式，建议重定向到一个简单的中间页展示图片，或者直接重定向到图片资源地址。



### 4.4 个人中心

* **积分展示**：显示当前剩余积分。
* **邀请系统**：
* 展示用户的唯一邀请链接。
* 复制按钮。
* (可选) 展示已邀请人数。



---

## 5. 数据库设计 (SQLite)

建议使用 Prisma ORM 进行管理。

### 5.1 User 表 (用户)

| 字段名 | 类型 | 描述 |
| --- | --- | --- |
| `id` | String (UUID) | 主键 |
| `email` | String | 唯一，登录账号 |
| `password` | String | 加密后的密码 |
| `ip_address` | String | 注册时的 IP 地址 |
| `points` | Integer | 当前积分 (默认 20) |
| `referral_code` | String | 唯一邀请码 (可用 ID 代替) |
| `invited_by` | String (FK) | 邀请人的 ID (可选) |
| `created_at` | DateTime | 注册时间 |

### 5.2 DynamicCode 表 (活码)

| 字段名 | 类型 | 描述 |
| --- | --- | --- |
| `id` | String (UUID) | 主键 |
| `user_id` | String (FK) | 关联 User 表 |
| `short_code` | String | 唯一短码 (如 `aBc12`)，用于生成 URL |
| `type` | Enum | 类型：`LINK` 或 `IMAGE` |
| `target_content` | String | 目标 URL 或 图片的存储路径 |
| `active` | Boolean | 是否启用 (默认 True) |
| `visits` | Integer | (可选) 扫描/访问次数统计 |
| `created_at` | DateTime | 创建时间 |
| `updated_at` | DateTime | 最后修改时间 |

---

## 6. 技术架构与选型

### 6.1 前端 (Next.js App Router)

* **UI 库**：Tailwind CSS + Shadcn/ui (推荐，快速构建漂亮界面)。
* **状态管理**：React Context 或 Zustand (处理用户信息和积分状态)。
* **二维码生成库**：`qrcode.react` 或 `next-qrcode`。

### 6.2 后端 (Next.js API Routes / Server Actions)

* **Server Actions**：处理表单提交（登录、注册、创建活码），直接在服务端执行数据库操作。
* **Middleware**：
* `middleware.ts` 用于路由保护（未登录无法访问 `/dashboard`）。
* 也可以在 Middleware 中处理短链接跳转（根据 URL path 查询 DB 并重定向），以获得更快的响应速度。



### 6.3 文件存储 (图片上传)

* 由于使用 SQLite，如果是单机部署，可以直接存储在本地 `public/uploads` 文件夹。
* *建议*：为了扩展性，建议使用 AWS S3 兼容的对象存储（如 MinIO, Cloudflare R2, 阿里云 OSS）。

---

## 7. 页面结构规划

1. **/** (Landing Page)：产品介绍，引导登录/注册。
2. **/login**：登录页。
3. **/register**：注册页 (支持 `?ref=xxx` 参数)。
4. **/dashboard** (需鉴权)：
* 顶部：积分显示、创建按钮。
* 主体：活码列表卡片。


5. **/dashboard/create** (需鉴权)：创建活码表单（上传/输入链接）。
6. **/dashboard/edit/[id]** (需鉴权)：修改活码指向。
7. **/profile** (需鉴权)：展示邀请链接，账户信息。
8. **/q/[code]** (公共)：跳转逻辑处理路由（无 UI，直接 302）。

---

## 8. 非功能性需求

* **安全性**：
* 密码必须 Hash 存储 (使用 bcrypt 或 argon2)。
* 上传图片需校验文件类型（仅限 jpg/png）和大小（如 < 5MB）。
* 防止 SQL 注入 (ORM 自带防护)。


* **性能**：二维码跳转响应时间应在 500ms 以内。

---

## 9. 开发阶段规划 (Roadmap)

1. **阶段一：基础设施**
* 搭建 Next.js + SQLite + Prisma 环境。
* 完成 User 数据库模型设计。


2. **阶段二：认证与积分**
* 实现注册（含 IP 校验、初始积分）。
* 实现登录、邀请码逻辑（注册时增加邀请人积分）。


3. **阶段三：核心业务**
* 实现活码表单（图片上传、URL 输入）。
* 实现 `q/[code]` 跳转逻辑。
* 实现创建时扣除积分逻辑。


4. **阶段四：UI 与 完善**
* Dashboard 界面开发。
* 二维码展示与下载功能。
* 测试与部署。